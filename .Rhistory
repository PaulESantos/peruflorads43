}
cat("\n")
}
# Ejemplo de uso de la función detallada
cat("\n=== BÚSQUEDAS DETALLADAS ===\n")
walk(especies_interes, buscar_especie_detallada)
# Función para crear un reporte en formato tabla
crear_reporte_especies <- function(lista_especies) {
reporte <- tibble(
especie = lista_especies,
estado = search_ds043(lista_especies)
) %>%
rowwise() %>%
mutate(
detalles = list(obtener_categoria_segura(especie))
) %>%
unnest(detalles) %>%
select(
`Especie consultada` = especie,
`Estado` = estado,
`Categoría` = category,
`Nombre aceptado` = accepted_name,
`Familia` = accepted_family
) %>%
mutate(
Estado = case_when(
Estado == "Present" ~ "✓ Presente",
Estado == "P_updated_name" ~ "⚠ Nombre actualizado",
Estado == "" ~ "✗ No encontrada",
TRUE ~ Estado
)
)
return(reporte)
}
# Crear reporte final
cat("\n=== REPORTE FINAL ===\n")
reporte_final <- crear_reporte_especies(especies_interes)
print(reporte_final)
devtools::load_all()
devtools::load_all()
splist <- c("Cleistocactus clavispinus",
"Welfia alfredi",
"Matucana haynei")
category_ds043_2006(splist
category_ds043_2006(splist
category_ds043_2006(splist )
search_ds043(splist)
peruflorads43::ds_043_2006_ag
peruflorads43::ds_043_2006_ag |>  tibble::as_tibble()
peruflorads43::tab_ds43_2006 |>  tibble::as_tibble()
peruflorads43::ds43_2006_sps_class |>  tibble::as_tibble()
peruflorads43::tab_ds43_2006_position |>  tibble::as_tibble()
library(tidyverse)
ds43 <- readxl::read_excel("ds_043_2016.xlsx")
ds43 |>  names()
ds43
ds_43 <- ds43 |>
mutate(ESPECIE =  case_when(
is.na(ESPECIE) & !is.na(...2) ~ ...2,
TRUE ~ ESPECIE
)) |>
filter(!if_all(everything(), is.na)) |>
mutate(categoria =  case_when(
is.na(ESPECIE) ~ FAMILIA,
TRUE ~ NA_character_
)) |>
tidyr::fill(categoria, .direction = "down") |>
filter(FAMILIA != "FAMILIA") |>
mutate(`NOMBRE COMUN` = case_when(
is.na(`NOMBRE COMUN`) & !is.na(...5) ~ ...5,
is.na(`NOMBRE COMUN`) & !is.na(...6) ~ ...6,
TRUE ~ `NOMBRE COMUN`
)) |>
select(categoria, FAMILIA, ESPECIE, `NOMBRE COMUN`) |>
janitor::clean_names() |>
mutate(familia = str_extract(familia, "[A-Z]{1,}"))
ds_43 <-
ds_43  |>
#select(especie) |>
mutate(genero = stringr::word(especie, 1),
specific_epithet = stringr::word(especie, 2)
)  |>
mutate(especie =
str_replace(especie, "var\\.", "var\\. ") |>
str_trim() |>
str_squish()) |>
#filter(str_detect(especie,
#                  "subsp\\.|var\\.")) |>
mutate(
# Extraer el patrón 'subsp.' o 'var.' en una nueva columna 'tag'
tag = case_when(
str_detect(especie, "subsp\\.") ~ "subsp.",
str_detect(especie, "var\\.") ~ "var.",
TRUE ~ NA_character_
),
# Extraer la palabra que sigue a 'subsp.' o 'var.' y asignarla a 'infraespecie'
infraespecie = case_when(
str_detect(especie, "subsp\\.") ~ str_extract(especie, "(?<=subsp\\.\\s)\\w+"),
str_detect(especie, "var\\.") ~ str_extract(especie, "(?<=var\\.\\s)\\w+"),
TRUE ~ NA_character_
)
) |>
rowwise() |>
mutate(scientific_name =
case_when(
is.na(tag) ~ paste(genero,
specific_epithet,
collapse =  " "),
!is.na(tag) ~ paste(genero,
specific_epithet,
tag,
infraespecie,
collapse =  " ")
))
ds_43
ds_43 |>
distinct(categoria)
ds_43 |>  distinct()
#writexl::write_xlsx("ds_043_2016_p.xlsx")
library(tidyverse)
ds43 <- readxl::read_xlsx("ds_043_2016_p.xlsx")
ds43
pspecies <- ds43 |>
select(scientific_name) |>
pull(scientific_name) |>
unique() |>
str_trim() |>
str_squish()
pspecies[1:6]
ds43$especie
ds_species <- ds43$scientific_name
ds_species |>  class()
pspecies |>  class()
pspecies |>  length()
ds_species |>  length()
table(ds_species) |>
as.data.frame() |>
as_tibble() |>
filter(Freq > 1) |>
pull(ds_species) |>
as.vector()
ds_species |>
count()
ds43 |>  count(scientific_name)
ds43 |>
count(scientific_name) |>
filter(n > 1)
dplyr::setdiff(ds_species, pspecies)
dplyr::setdiff(pspecies, ds_species)
ds43 |>
filter(scientific_name %in% c(
"Bishopanthus soliceps",
"Haageocereus acranthus subsp. olowinskianus",
"Haageocereus pseudomelanostele subsp. setosus"
)) |>
select(id, categoria, especie, scientific_name, familia) |>
arrange(especie) |>
select(1:3)
ds43 |>
filter(fuente == "adiciones")
library(tidyverse)
ds43 <- readxl::read_xlsx("ds_043_2016_p.xlsx")
ds43
ds43 |>
select(especie)
ds43 |>
select(especie, genero, specific_epithet)
ds43 |>
select(especie, genero, specific_epithet) |>
mutate(author = str_remove_all(especie,
paste0(genero, "|", specific_epithet)))
ds43 |>
select(especie, genero, specific_epithet) |>
rowwise() |>
mutate(author = str_remove_all(especie,
paste0(genero, "|", specific_epithet)) |>
str_squish())
ds43
ds43 |>
filter(!is.na(tag))
ds43 |>
filter(!is.na(tag))
ds43 |>
filter(!is.na(forma))
ds43 |>
filter(!is.na(forma)) |>
select(especie, genero, specific_epithet)
ds43 |>
#select(especie, genero, specific_epithet) |>
rowwise() |>
mutate(author = str_remove_all(especie,
paste0(genero,
"|",
specific_epithet,
"|",
infraespecie,
"| ",
forma, " ")) |>
str_squish())
ds43 |>
#select(especie, genero, specific_epithet) |>
rowwise() |>
mutate(author = str_remove_all(especie,
paste0(genero,
"|",
specific_epithet,
"|",
infraespecie,
"| ",
forma, " ")) |>
str_squish()) |>
filter(!is.na(forma)) |>
select(especie, genero, specific_epithet)
ds43 |>
#select(especie, genero, specific_epithet) |>
rowwise() |>
mutate(author = str_remove_all(especie,
paste0(genero,
"|",
specific_epithet,
"|",
infraespecie,
"| ",
forma, " ")) |>
str_squish()) |>
filter(!is.na(forma)) |>
select(especie, author)
ds43 |>
#select(especie, genero, specific_epithet) |>
rowwise() |>
mutate(author = str_remove_all(especie,
paste0(genero,
"|",
specific_epithet,
"|",
infraespecie,
"| ",
forma, " ",
"| subsp\\. | forma ")) |>
str_squish()) |>
filter(!is.na(forma)) |>
select(especie, author)
ds43 |>
#select(especie, genero, specific_epithet) |>
rowwise() |>
mutate(author = str_remove_all(especie,
paste0(genero,
"|",
specific_epithet,
"|",
infraespecie,
"| ",
forma,
"| subsp\\. | forma ")) |>
str_squish()) |>
filter(!is.na(forma)) |>
select(especie, author)
ds43 |>
#select(especie, genero, specific_epithet) |>
rowwise() |>
mutate(author = str_remove_all(especie,
paste0(genero,
"|",
specific_epithet,
"|",
infraespecie,
"|",
forma,
"| subsp\\. | forma ")) |>
str_squish()) |>
filter(!is.na(forma)) |>
select(especie, author)
ds43 |>
#select(especie, genero, specific_epithet) |>
rowwise() |>
mutate(author = str_remove_all(especie,
paste0(genero,
"|",
specific_epithet,
"|",
infraespecie,
"|",
forma,
"| subsp\\. | forma ")) |>
str_squish()) |>
filter(!is.na(tag)) |>
select(especie, author)
ds43 |>
#select(especie, genero, specific_epithet) |>
rowwise() |>
mutate(author = str_remove_all(especie,
paste0(genero,
"|",
specific_epithet,
"|",
infraespecie,
"|",
forma,
"| subsp\\. | forma ")) |>
str_squish())
ds43 |>
#select(especie, genero, specific_epithet) |>
rowwise() |>
mutate(author = str_remove_all(especie,
paste0(genero,
"|",
specific_epithet,
"|",
infraespecie,
"|",
forma,
"| subsp\\. | forma ")) |>
str_squish()) |>
writexl::write_xlsx("ds_043_2006.xlsx")
ds43 |>
#select(especie, genero, specific_epithet) |>
rowwise() |>
mutate(author = str_remove_all(especie,
paste0(genero,
"|",
specific_epithet,
"|",
infraespecie,
"|",
forma,
"| subsp\\. | forma ")) |>
str_squish()) |>
writexl::write_xlsx("ds_043_2006_092025.xlsx")
library(tidyverse)
library(TNRS)
df <- readxl::read_excel("ds_043_2006_092025.xlsx")
species <- df$scientific_name |>  unique()
length(species)
df |>
count(scientific_name) |>
filter(n>1)
length(species)
ds_tnrs <- TNRS(species,
sources = "wcvp")
ds_tnrs
ds_tnrs |>
select(Name_submitted,
contains("Accepted"))
ds_tnrs |>
select(Name_submitted,
contains("Accepted_"))
ds_tnrs |>
select(Name_submitted,
Accepted_name,
Accepted_name_author,
Accepted_family,
acce)
ds_tnrs |>
select(Name_submitted,
Accepted_name,
Accepted_name_author,
Accepted_family)
ds_tnrs |>
select(Name_submitted,
Accepted_name,
Accepted_name_author,
Accepted_family) |>
as_tibble()
ds_tnrs |>
select(Name_submitted,
Accepted_name,
Accepted_name_author,
Accepted_family) |>
as_tibble() |>
writexl::write_xlsx("ds_043_2006_092025_tnrs.xlsx")
df <- readxl::read_excel("ds_043_2006_092025.xlsx")
df <- readxl::read_excel("ds_043_2006_092025_tnrs.xlsx")
df
df <- readxl::read_excel("ds_043_2006_092025.xlsx")
df2 <- readxl::read_excel("ds_043_2006_092025_tnrs.xlsx")
df
df2
df <- readxl::read_excel("ds_043_2006_092025.xlsx") |>
dplyr::distinct()
df
library(tidyverse)
df |>
add_count(scientific_name)
df |>
add_count(scientific_name) |>
filter(n != 1)
df |>
add_count(scientific_name) |>
filter(n != 1) |>
select(scientific_name)
df |>
add_count(scientific_name) |>
filter(n != 1)
df <- readxl::read_excel("ds_043_2006_092025.xlsx") |>
dplyr::distinct()
df
df <- readxl::read_excel("ds_043_2006_092025.xlsx") |>
dplyr::distinct()
df |>
add_count(scientific_name) |>
filter(n != 1) |>
select(scientific_name)
df |>
add_count(scientific_name) |>
filter(n != 1)
df |>
dplyr::slice(-21)
df2
df |>
dplyr::slice(-21) |>
dplyr::left_join(df2,
by = c(
"scientific_name" = "Name_submitted"
))
df |>
dplyr::slice(-21) |>
dplyr::left_join(df2,
by = c(
"scientific_name" = "Name_submitted"
))
species <- df$scientific_name |>  unique()
length(species)
ds_tnrs <- TNRS(species,
sources = "wcvp")
library(TNRS)
ds_tnrs <- TNRS(species,
sources = "wcvp")
df <- readxl::read_excel("ds_043_2006_092025.xlsx") |>
dplyr::distinct()
df |>
write_csv("ds_043_2006_092025.csv")
df |>
write_delim("ds_043_2006_092025.txt", delim = "\t")
usethis::create_tidy_package("D:\\ds43")
options(cli.ignore_unknown_rstudio_theme = TRUE)
library(tidyverse)
df <- readxl::read_excel("ds_043_2006_092025.xlsx") |>
dplyr::distinct()
df_tnrs <- readxl::read_excel("ds_043_2006_092025_tnrs.xlsx")
df
df_tnrs
df <- readxl::read_excel("ds_043_2006_092025.xlsx") |>
dplyr::distinct() |>
dplyr::slice(21,42)
df
df <- readxl::read_excel("ds_043_2006_092025.xlsx") |>
dplyr::distinct() |>
dplyr::slice(-42)
df
df
df_tnrs
df |>
dplyr::left_join(df_tnrs,
by = c("scientific_name" = "Name_submitted"))
ds43 <- df |>
dplyr::left_join(df_tnrs,
by = c("scientific_name" = "Name_submitted"))
ds43 |>
dplyr::select(author, Accepted_name_author)
ds43 |>
dplyr::select(author, Accepted_name_author) |>
dplyr::mutate(comp = Accepted_name_author == author)
ds43 |>
dplyr::select(author, Accepted_name_author) |>
dplyr::mutate(comp = Accepted_name_author == author) |>
dplyr::filter(comp != TRUE)
ds43 <- df |>
dplyr::left_join(df_tnrs,
by = c("scientific_name" = "Name_submitted")) |>
dplyr::mutate(comp = Accepted_name_author == author)
ds43 |>
writexl::write_xlsx("ds_043_2006_092025_f1.xlsx")
df <- readxl::read_excel("ds_043_2006_092025.xlsx") |>
dplyr::distinct()
library(TNRS)
df
spcies <- df$scientific_name |>
unique()
df_tnrs <- TNRS::TNRS(spcies,
sources = "wcvp")
df_tnrs |>
dplyr::select(Name_submitted,
Accepted_name,
Accepted_family,
Accepted_name_author,
Taxonomic_status)
df_tnrs |>
dplyr::select(Name_submitted,
Accepted_name,
Accepted_family,
Accepted_name_author,
Taxonomic_status) |>
tibble::as_tibble()
df_tnrs_1 <- df_tnrs |>
dplyr::select(Name_submitted,
Accepted_name,
Accepted_family,
Accepted_name_author,
Taxonomic_status) |>
tibble::as_tibble()
df_tnrs_1 |>
writexl::write_xlsx("ds_043_2006_092025_tnrs.xlsx")
df_tnrs <- readxl::read_excel("ds_043_2006_092025_tnrs.xlsx")
df
df_tnrs
ds43 <- df |>
dplyr::slice(-21) |>
dplyr::left_join(df_tnrs,
by = c("scientific_name" = "Name_submitted")) |>
dplyr::mutate(comp = Accepted_name_author == author)
ds43 |>
writexl::write_xlsx("ds_043_2006_092025_f1.xlsx")
