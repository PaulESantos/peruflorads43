expect_match(result[1], "CR|EN|VU|NT")
expect_match(result[2], "CR|EN|VU|NT")
# Last should be not threatened
expect_equal(result[3], "Not threatened")
})
test_that("Complete pipeline: comparison_table_ds043 integration", {
# Test comparison table generation end-to-end
input <- c(
"Cattleya maxima",
"Stenomesson leucanthum",
"Persea americana"
)
result <- comparison_table_ds043(input)
# Check structure
expect_s3_class(result, "data.frame")
expect_equal(nrow(result), 3)
# Check required columns exist
expect_true("protected_by_ds_043" %in% colnames(result))
expect_true("input_species" %in% colnames(result))
# Check YES/NO format
expect_true(all(result$protected_by_ds_043 %in% c("YES", "NO")))
# First two should be YES
expect_equal(result$protected_by_ds_043[1:2], c("YES", "YES"))
# Last should be NO
expect_equal(result$protected_by_ds_043[3], "NO")
})
test_that("Complete pipeline: mixed case input standardization", {
# Different case inputs should all match correctly
input <- c(
"cattleya maxima",        # lowercase
"POLYLEPIS INCANA",       # uppercase
"Puya Raimondii",         # title case
"ApHeLaNdRa CuScOeNsIs"  # mixed case
)
result <- is_threatened_peru(input,
source = "original",
return_details = TRUE)
# All should match despite different cases
expect_true(all(result$matched))
# All matched names should be in proper format
expect_match(result$Matched.Name[1], "^[A-Z][a-z]+ [a-z]+$")
})
test_that("Complete pipeline: whitespace variations handled", {
# Various whitespace patterns should be normalized
input <- c(
" Cattleya maxima",          # Leading space
"Polylepis incana ",         # Trailing space
"  Puya raimondii  ",        # Both
"Aphelandra    cuscoensis"   # Multiple internal spaces
)
result <- is_threatened_peru(input,
source = "original",
return_details = TRUE)
# All should match after normalization
expect_true(all(result$matched))
# Matched names should have no extra whitespace
expect_false(any(grepl("  ", result$Matched.Name, fixed = TRUE)))
expect_false(any(grepl("^ | $", result$Matched.Name)))
})
test_that("Complete pipeline: NA and empty values handled", {
# Mix of valid, NA, and empty values
input <- c(
"Cattleya maxima",
NA,
"Polylepis incana",
"",
"   ",  # Only whitespace
"Aphelandra cuscoensis"
)
result <- suppressMessages(
is_threatened_peru(input,
source = "original",
return_details = FALSE)
)
# Should return result for all inputs
expect_length(result, 6)
# NA and empty should be "Not threatened"
expect_equal(result[c(2, 4, 5)],
rep("Not threatened", 3))
# Valid names should have proper status
expect_true(result[1] != "Not threatened")
expect_true(result[3] != "Not threatened")
expect_true(result[5] == "Not threatened")
})
test_that("Complete pipeline: duplicate names handled", {
# Duplicate names should all get same result
input <- c(
"Cattleya maxima",
"Cattleya maxima",
"Polylepis incana",
"Cattleya maxima"
)
result <- is_threatened_peru(input,
source = "original",
return_details = TRUE)
# Should have 4 rows (not deduplicated)
expect_equal(nrow(result), 4)
# All Cattleya maxima should have same status
cattleya_results <- result$Threat.Status[c(1, 2, 4)]
expect_true(all(cattleya_results == cattleya_results[1]))
})
test_that("Complete pipeline: performance with large datasets", {
# Test that large datasets process in reasonable time
# All unique species from original database (~776 species)
input <- peruflorads43:::threatenedperu$scientific_name |> unique()
# Should complete in reasonable time (< 30 seconds for ~800 species)
start_time <- Sys.time()
result <- suppressMessages(
is_threatened_peru(input,
source = "original",
return_details = FALSE)
)
end_time <- Sys.time()
elapsed <- as.numeric(difftime(end_time, start_time, units = "secs"))
# Performance check
expect_lt(elapsed, 30)  # Should complete in under 30 seconds
# Correctness check
expect_length(result, length(input))
expect_true(all(result != "Not threatened"))
})
test_that("Complete pipeline: small batch performance", {
# Small batches should be nearly instant
input <- c("Cattleya maxima", "Polylepis incana", "Aphelandra cuscoensis")
start_time <- Sys.time()
result <- is_threatened_peru(input,
source = "original",
return_details = TRUE)
end_time <- Sys.time()
elapsed <- as.numeric(difftime(end_time, start_time, units = "secs"))
# Should be very fast (< 2 seconds)
expect_lt(elapsed, 2)
})
test_that("Complete pipeline: output format is consistent across functions", {
# Different functions should return consistent formats
input <- c("Cattleya maxima", "Persea americana")
# Test is_threatened_peru
result1 <- is_threatened_peru(input, return_details = FALSE)
expect_type(result1, "character")
expect_length(result1, 2)
# Test check_ds043
result2 <- check_ds043(input)
expect_type(result2, "character")
expect_length(result2, 2)
# Test is_ds043_2006_ag
result3 <- is_ds043_2006_ag(input, return_details = FALSE)
expect_type(result3, "character")
expect_length(result3, 2)
})
test_that("Complete pipeline: detailed output has all required columns", {
# Check that detailed output contains all expected columns
input <- "Cattleya maxima"
result <- is_threatened_peru(input,
source = "original",
return_details = TRUE)
# Critical columns must exist
critical_cols <- c(
"sorter", "Orig.Name", "Matched.Name",
"Threat.Status", "Rank", "Matched.Rank",
"Comp.Rank", "Match.Level", "matched",
"threat_category"
)
expect_true(all(critical_cols %in% colnames(result)))
})
devtools::document()
devtools::load_all()
devtools::check()
splist <- c(NA, NA, "Aphelandra formosa")
is_threatened_peru(splist)
splist <- c(NA, NA)
is_threatened_peru(splist)
is_threatened_peru(threatenedperu$scientific_name[c(23, 45, 123, 234)])
input <- c("Microchilus", "Opuntia pubescens"  )
is_threatened_peru(splist = input)
matching_threatenedperu(splist = threatenedperu$scientific_name[c(23, 45, 123, 234)],
source = "original")
tictoc::tic()
original_ds <- is_threatened_peru(threatenedperu$scientific_name,
return_details = TRUE,
source = "original")
tictoc::toc()
original_ds |>
dplyr::select(Orig.Name, Matched.Name) |>
dplyr::mutate(compara = Orig.Name == Matched.Name) |>
dplyr::filter(compara != TRUE) |>
as.data.frame()
tictoc::tic()
updated_ds <- is_threatened_peru(threatenedperu_syn$accepted_name,
return_details = TRUE,
source = "updated")
tictoc::toc()
threatenedperu_syn |>
dplyr::filter(stringr::str_detect(accepted_name, "^x")) |>
as.data.frame()
updated_ds |>
dplyr::select(Orig.Name, Matched.Name) |>
dplyr::filter(Matched.Name != "---") |>
dplyr::mutate(compara = Orig.Name == Matched.Name) |>
dplyr::filter(compara != TRUE) |>
as.data.frame()
result <- is_threatened_peru(c("Persea americana",
"catleya maxima",
"catleya maxima",
"persea incana"
),
return_details = TRUE)
result |>
as.data.frame()
get_ambiguous_matches(result, "genus")
splist <- "Haageocereus acranthus subsp. olowinskianus f. deflexispinus"
result <- is_threatened_peru(splist = splist, return_details = TRUE)
get_ambiguous_matches(result, type = "infraspecies")
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
library(peruflorads43)
library(dplyr)
library(tibble)
library(ggplot2)
library(scales)
library(gt)
category_summary <- threatenedperu |>
count(threat_category) |>
mutate(pct = round(100 * n / sum(n), 1))
category_summary
ggplot(category_summary, aes(x = threat_category, y = n, fill = threat_category)) +
geom_col(show.legend = FALSE) +
geom_text(aes(label = paste0(n, " (", pct, "%)")), vjust = -0.5) +
labs(title = "Distribución de especies por categoría de amenaza",
x = "Categoría IUCN", y = "Número de especies")
status_summary <- threatenedperu |>
count(taxonomic_status) |>
mutate(pct = round(100 * n / sum(n), 1))
status_summary
ggplot(status_summary, aes(x = taxonomic_status, y = pct, fill = taxonomic_status)) +
geom_col(show.legend = FALSE) +
geom_text(aes(label = paste0(pct, "%")), vjust = -0.5) +
labs(title = "Proporción de nombres por estado taxonómico",
x = "Estatus taxonómico", y = "Porcentaje (%)")
pak::pak("PaulESantos/peruflorads43")
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
library(peruflorads43)
library(dplyr)
library(tibble)
library(ggplot2)
library(scales)
library(gt)
status_summary <- threatenedperu |>
count(taxonomic_status) |>
mutate(pct = round(100 * n / sum(n), 1),
label = paste0(pct, "% (", n, ")"))
threatenedperu <- get_threatened_database(type = "original")
devtools::check()
devtools::check()
devtools::document()
devtools::check()
devtools::build()
library(testthat)
devtools::load_all()
test_that("get_ambiguous_matches returns NULL when no ambiguous matches", {
skip_on_cran()
# Use species that match unambiguously
species_list <- c("Cattleya maxima", "Polylepis incana")
matching_threatenedperu(species_list)
result <- is_threatened_peru(species_list, return_details = TRUE)
# Should return NULL and message
expect_message(
ambig <- get_ambiguous_matches(result, type = "genus"),
"No ambiguous.*found"
)
expect_null(ambig)
})
test_that("get_ambiguous_matches validates input", {
# Test with invalid input
expect_error(
get_ambiguous_matches("not a dataframe"),
"must be a data frame"
)
expect_error(
get_ambiguous_matches(list(a = 1, b = 2)),
"must be a data frame"
)
})
test_that("get_ambiguous_matches handles invalid type parameter", {
species_list <- c("Cattleya maxima")
result <- is_threatened_peru(species_list, return_details = TRUE)
# Invalid type should error via match.arg
expect_error(
get_ambiguous_matches(result, type = "invalid"),
"should be one of"
)
})
test_that("get_ambiguous_matches handles missing output directory", {
#skip_on_cran()
species_list <- c("Cattleya maxima")
result <- is_threatened_peru(species_list, return_details = TRUE)
# Non-existent directory should be created
temp_base <- tempdir()
new_dir <- file.path(temp_base, "new_test_dir", "nested")
# Ensure directory doesn't exist
if (dir.exists(new_dir)) {
unlink(new_dir, recursive = TRUE)
}
# Should create directory and not error
expect_no_error({
get_ambiguous_matches(
result,
type = "genus",
save_to_file = TRUE,
output_dir = new_dir
)
})
# Cleanup
if (dir.exists(new_dir)) {
unlink(new_dir, recursive = TRUE)
}
})
test_that("Complete pipeline: small batch performance", {
# Small batches should be nearly instant
input <- c("Cattleya maxima", "Polylepis incana", "Aphelandra cuscoensis")
start_time <- Sys.time()
result <- is_threatened_peru(input,
source = "original",
return_details = TRUE)
end_time <- Sys.time()
elapsed <- as.numeric(difftime(end_time, start_time, units = "secs"))
# Should be very fast (< 2 seconds)
expect_lt(elapsed, 2)
})
input <- c("Cattleya maxima", "Polylepis incana", "Aphelandra cuscoensis")
start_time <- Sys.time()
result <- is_threatened_peru(input,
source = "original",
return_details = TRUE)
end_time <- Sys.time()
elapsed <- as.numeric(difftime(end_time, start_time, units = "secs"))
elapsed
# Should be very fast (< 2 seconds)
expect_lt(elapsed, 2)
# Should be very fast (< 2 seconds)
expect_lt(elapsed, 3)
input <- c("Cattleya maxima", "Polylepis incana", "Aphelandra cuscoensis")
start_time <- Sys.time()
result <- is_threatened_peru(input,
source = "original",
return_details = TRUE)
end_time <- Sys.time()
elapsed <- as.numeric(difftime(end_time, start_time, units = "secs"))
# Should be very fast (< 2 seconds)
expect_lt(elapsed, 3)
test_that("Complete pipeline: small batch performance", {
# Small batches should be nearly instant
input <- c("Cattleya maxima", "Polylepis incana", "Aphelandra cuscoensis")
start_time <- Sys.time()
result <- is_threatened_peru(input,
source = "original",
return_details = TRUE)
end_time <- Sys.time()
elapsed <- as.numeric(difftime(end_time, start_time, units = "secs"))
#elapsed
# Should be very fast (< 2 seconds)
expect_lt(elapsed, 3)
})
test_that("Complete pipeline: output format is consistent across functions", {
# Different functions should return consistent formats
input <- c("Cattleya maxima", "Persea americana")
# Test is_threatened_peru
result1 <- is_threatened_peru(input, return_details = FALSE)
expect_type(result1, "character")
expect_length(result1, 2)
# Test check_ds043
result2 <- check_ds043(input)
expect_type(result2, "character")
expect_length(result2, 2)
# Test is_ds043_2006_ag
result3 <- is_ds043_2006_ag(input, return_details = FALSE)
expect_type(result3, "character")
expect_length(result3, 2)
})
devtools::document()
devtools::check()
devtools::build()
cranlogs::cran_downloads("peruflorads43")
cranlogs::cran_downloads("peruflorads43". "last-month")
cranlogs::cran_downloads("peruflorads43", "last-month")
cranlogs::cran_downloads("avesperu", "last-month")
cranlogs::cran_downloads("ppendemic", "last-month")
test_that("get_ambiguous_matches returns NULL when no ambiguous matches", {
# Use species that match unambiguously
species_list <- c("Cattleya maxima", "Polylepis incana")
matching_threatenedperu(species_list)
result <- is_threatened_peru(species_list, return_details = TRUE)
# Should return NULL and message
expect_message(
ambig <- get_ambiguous_matches(result, type = "genus"),
"No ambiguous.*found"
)
expect_null(ambig)
})
library(testthat)
test_that("get_ambiguous_matches returns NULL when no ambiguous matches", {
# Use species that match unambiguously
species_list <- c("Cattleya maxima", "Polylepis incana")
matching_threatenedperu(species_list)
result <- is_threatened_peru(species_list, return_details = TRUE)
# Should return NULL and message
expect_message(
ambig <- get_ambiguous_matches(result, type = "genus"),
"No ambiguous.*found"
)
expect_null(ambig)
})
devtools::load_all()
test_that("get_ambiguous_matches returns NULL when no ambiguous matches", {
# Use species that match unambiguously
species_list <- c("Cattleya maxima", "Polylepis incana")
matching_threatenedperu(species_list)
result <- is_threatened_peru(species_list, return_details = TRUE)
# Should return NULL and message
expect_message(
ambig <- get_ambiguous_matches(result, type = "genus"),
"No ambiguous.*found"
)
expect_null(ambig)
})
test_that("get_ambiguous_matches returns NULL when no ambiguous matches", {
# Use species that match unambiguously
species_list <- c("Cattleya maxima", "Polylepis incana")
matching_threatenedperu(species_list)
result <- is_threatened_peru(species_list, return_details = TRUE)
# Should return NULL and message
expect_message(
ambig <- get_ambiguous_matches(result, type = "genus"),
"No ambiguous.*found"
)
expect_null(ambig)
})
test_that("get_ambiguous_matches validates input", {
# Test with invalid input
expect_error(
get_ambiguous_matches("not a dataframe"),
"must be a data frame"
)
expect_error(
get_ambiguous_matches(list(a = 1, b = 2)),
"must be a data frame"
)
})
test_that("get_ambiguous_matches handles invalid type parameter", {
species_list <- c("Cattleya maxima")
result <- is_threatened_peru(species_list, return_details = TRUE)
# Invalid type should error via match.arg
expect_error(
get_ambiguous_matches(result, type = "invalid"),
"should be one of"
)
})
test_that("get_ambiguous_matches handles missing output directory", {
#skip_on_cran()
species_list <- c("Cattleya maxima")
result <- is_threatened_peru(species_list, return_details = TRUE)
# Non-existent directory should be created
temp_base <- tempdir()
new_dir <- file.path(temp_base, "new_test_dir", "nested")
# Ensure directory doesn't exist
if (dir.exists(new_dir)) {
unlink(new_dir, recursive = TRUE)
}
# Should create directory and not error
expect_no_error({
get_ambiguous_matches(
result,
type = "genus",
save_to_file = TRUE,
output_dir = new_dir
)
})
# Cleanup
if (dir.exists(new_dir)) {
unlink(new_dir, recursive = TRUE)
}
})
devtools::document()
devtools::check()
rhub::check_for_cran()
?rhubv2
rhub::rhub_check()
devtools::build()
devtools::document()
devtools::load_all()
devtools::check()
#rhub::check_for_cran()
devtools::build()
devtools::document()
devtools::load_all()
devtools::check()
#rhub::check_for_cran()
devtools::build()
usethis::use_tidy_github_actions()
devtools::document()
devtools::check()
devtools::document()
devtools::check()
devtools::check()
devtools::document()
devtools::check()
devtools::document()
devtools::check()
devtools::build()
